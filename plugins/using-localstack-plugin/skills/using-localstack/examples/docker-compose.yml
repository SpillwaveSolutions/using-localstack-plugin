version: "3.8"

# Production-grade LocalStack Docker Compose configuration
# Supports Docker-based Lambda, Fargate, and complex networking

services:
  localstack:
    container_name: "${LOCALSTACK_DOCKER_NAME:-localstack_main}"
    image: localstack/localstack-pro:3.0.2  # Pin version for reproducibility
    
    ports:
      # Edge port (all service APIs route through this)
      - "127.0.0.1:4566:4566"
      
      # External service port range (RDS/Elasticsearch/OpenSearch direct access)
      - "127.0.0.1:4510-4559:4510-4559"
    
    environment:
      # Authentication
      - LOCALSTACK_AUTH_TOKEN=${LOCALSTACK_AUTH_TOKEN:?Error: LOCALSTACK_AUTH_TOKEN required for Pro}
      
      # Debugging
      - DEBUG=${DEBUG:-0}
      - LS_LOG=${LS_LOG:-info}  # Options: trace, debug, info, warn, error
      
      # Docker integration (critical for Lambda/Fargate)
      - DOCKER_HOST=unix:///var/run/docker.sock
      
      # Lambda networking (ensures Lambda containers join this network)
      - LAMBDA_DOCKER_NETWORK=localstack_network
      
      # Lambda runtime tuning
      - LAMBDA_KEEPALIVE_MS=600000  # Keep warm containers alive 10 minutes
      - LAMBDA_DOCKER_FLAGS=-p 9229:9229  # Expose Node.js debugger port
      
      # Service scope (limit to needed services for faster startup)
      - SERVICES=${SERVICES:-s3,lambda,ecs,ecr,cloudwatch,dynamodb,sqs,sns,eventbridge}
      
      # Persistence (cache runtimes and state)
      - PERSISTENCE=1
      
      # IAM enforcement (Pro only)
      - ENFORCE_IAM=${ENFORCE_IAM:-0}
      - IAM_SOFT_MODE=${IAM_SOFT_MODE:-1}  # Log IAM violations without blocking
      
      # Network configuration
      - LOCALSTACK_HOST=localhost.localstack.cloud
      
      # ECS/Fargate configuration
      - ECS_REMOVE_CONTAINERS=1  # Auto-cleanup stopped task containers
      
      # Eager service loading (pre-warm services)
      - EAGER_SERVICE_LOADING=${EAGER_SERVICE_LOADING:-0}
    
    volumes:
      # State persistence (Lambda runtimes, DynamoDB data, S3 objects)
      - "${LOCALSTACK_VOLUME_DIR:-./volume}:/var/lib/localstack"
      
      # Docker socket (REQUIRED for Lambda/Fargate container orchestration)
      - "/var/run/docker.sock:/var/run/docker.sock"
      
      # Init scripts (seed resources on startup)
      - "./init:/etc/localstack/init/ready.d:ro"
    
    networks:
      - localstack_network
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

networks:
  localstack_network:
    driver: bridge
    name: localstack_network
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Optional: Run application alongside LocalStack
# Uncomment to add your own containers that need LocalStack access
#
#  app:
#    build: ./app
#    environment:
#      - AWS_ENDPOINT_URL=http://localstack:4566
#      - AWS_DEFAULT_REGION=us-east-1
#      - AWS_ACCESS_KEY_ID=test
#      - AWS_SECRET_ACCESS_KEY=test
#    networks:
#      - localstack_network
#    depends_on:
#      localstack:
#        condition: service_healthy

# Usage:
#   export LOCALSTACK_AUTH_TOKEN=<your-token>
#   docker-compose up -d
#   docker-compose logs -f localstack
#   docker-compose down
